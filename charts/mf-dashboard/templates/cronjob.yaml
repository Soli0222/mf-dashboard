{{- range $index, $schedule := .Values.cronjob.schedules }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "mf-dashboard.fullname" $ }}-crawler-{{ $index }}
  labels:
    {{- include "mf-dashboard.labels" $ | nindent 4 }}
    app.kubernetes.io/component: crawler
spec:
  schedule: {{ $schedule.cron | quote }}
  timeZone: {{ $schedule.timeZone | default $.Values.cronjob.timeZone | quote }}
  concurrencyPolicy: {{ $.Values.cronjob.concurrencyPolicy }}
  successfulJobsHistoryLimit: {{ $.Values.cronjob.successfulJobsHistoryLimit }}
  failedJobsHistoryLimit: {{ $.Values.cronjob.failedJobsHistoryLimit }}
  jobTemplate:
    spec:
      backoffLimit: {{ $.Values.cronjob.backoffLimit }}
      template:
        metadata:
          labels:
            {{- include "mf-dashboard.labels" $ | nindent 12 }}
            app.kubernetes.io/component: crawler
        spec:
          restartPolicy: OnFailure
          containers:
            - name: crawler
              image: "{{ $.Values.crawler.image.repository }}:{{ $.Values.crawler.image.tag | default $.Chart.AppVersion }}"
              imagePullPolicy: {{ $.Values.crawler.image.pullPolicy }}
              envFrom:
                - secretRef:
                    name: {{ $.Values.credentials.existingSecret | default (printf "%s-credentials" (include "mf-dashboard.fullname" $)) }}
              env:
                {{- include "mf-dashboard.databaseEnv" $ | nindent 16 }}
                - name: CRAWLER_TIMEOUT_MS
                  value: {{ $.Values.crawler.timeoutMs | quote }}
                - name: SKIP_REFRESH
                  value: {{ $schedule.skipRefresh | default false | quote }}
                - name: REVALIDATION_URL
                  value: "http://{{ include "mf-dashboard.fullname" $ }}-web.{{ $.Release.Namespace }}/api/revalidate"
              resources:
                {{- toYaml $.Values.crawler.resources | nindent 16 }}
{{- end }}
